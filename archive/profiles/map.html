<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #main_map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }

        /* Custom Marker Styles */
        .marker-pin {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }

        .profile-pin {
            background: #0284c7;
        }

        .incident-pin {
            background: #ef4444;
        }

        .recent-pin {
            width: 16px;
            height: 16px;
            border: 2px solid white;
        }

        /* Global Popup Link Styles */
        .maplibregl-popup-content a {
            color: #0284c7 !important;
            text-decoration: none;
            font-weight: bold;
            outline: none;
            border: none;
            box-shadow: none;
        }

        .maplibregl-popup-content a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div id="main_map"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 1. Parse URL Parameters
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lon = parseFloat(urlParams.get('lon'));
            const profileId = urlParams.get('profileId');
            const incLat = parseFloat(urlParams.get('incLat'));
            const incLon = parseFloat(urlParams.get('incLon'));
            const incId = urlParams.get('incId');
            const incFilename = urlParams.get('incFilename');
            const context = urlParams.get('context');
            const locationName = urlParams.get('location');
            const customTitle = urlParams.get('title');
            const linkUrl = urlParams.get('linkUrl');
            const linkText = urlParams.get('linkText') || 'View Details';

            // 2. Determine Initial View (Note: MapLibre uses [Lon, Lat])
            let startCenter = [10.2797, 47.4099]; // Default Allgäu
            let startZoom = 10;

            if (!isNaN(lat) && !isNaN(lon)) {
                startCenter = [lon, lat];
                startZoom = 14;
            } else if (!isNaN(incLat) && !isNaN(incLon)) {
                startCenter = [incLon, incLat];
                startZoom = 14; // Slightly zoomed out to see context
            }

            // 3. Initialize Map
            window.map = new maplibregl.Map({
                container: 'main_map',
                style: {
                    version: 8,
                    sources: {
                        'osm': {
                            type: 'raster',
                            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        },
                        'topo': {
                            type: 'raster',
                            tiles: ['https://a.tile.opentopomap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
                        }
                    },
                    layers: [
                        { id: 'osm-layer', type: 'raster', source: 'osm', minzoom: 0, maxzoom: 19 },
                        { id: 'topo-layer', type: 'raster', source: 'topo', minzoom: 0, maxzoom: 17, layout: { visibility: 'none' } }
                    ]
                },
                center: startCenter,
                zoom: startZoom
            });
            window.map.addControl(new maplibregl.NavigationControl());

            // 4. Dynamic Layer Switching
            function updateLayers() {
                const zoom = window.map.getZoom();
                if (zoom < 13) {
                    if (window.map.getLayer('topo-layer')) window.map.setLayoutProperty('topo-layer', 'visibility', 'none');
                    if (window.map.getLayer('osm-layer')) window.map.setLayoutProperty('osm-layer', 'visibility', 'visible');
                } else {
                    if (window.map.getLayer('osm-layer')) window.map.setLayoutProperty('osm-layer', 'visibility', 'none');
                    if (window.map.getLayer('topo-layer')) window.map.setLayoutProperty('topo-layer', 'visibility', 'visible');
                }
            }
            window.map.on('zoom', updateLayers);
            window.map.on('load', updateLayers);

            // 5. Add Markers

            // Title Logic
            let profileTitle = customTitle;
            if (!profileTitle) {
                if (context === 'coords') {
                    profileTitle = 'Relevant Profile';
                } else if (incId) {
                    profileTitle = 'Selected Profile';
                } else {
                    profileTitle = locationName || 'Selected Profile';
                }
            }
            const incidentTitle = (context === 'coords') ? 'Selected Incident' : 'Avalanche Incident';

            // Profile Marker
            let profileMarker;
            if (!isNaN(lat) && !isNaN(lon)) {
                const mapBackUrl = 'map.html' + window.location.search;
                const backParam = `?back=${encodeURIComponent(mapBackUrl)}`;

                let popupHTML = `<b>${profileTitle}</b>`;
                if (profileId) {
                    popupHTML += `<br><a href="${profileId}.html${backParam}" target="_parent" style="color:#0284c7; font-weight:bold;">View Profile →</a>`;
                } else if (linkUrl) {
                    popupHTML += `<br><a href="${linkUrl}" target="_parent" style="color:#0284c7; font-weight:bold;">${linkText} →</a>`;
                }

                const el = document.createElement('div');
                el.className = 'marker-pin profile-pin';

                profileMarker = new maplibregl.Marker({ element: el })
                    .setLngLat([lon, lat])
                    .setPopup(new maplibregl.Popup({ offset: 15 }).setHTML(popupHTML))
                    .addTo(window.map);
            }

            // Incident Marker
            let incidentMarker;
            if (!isNaN(incLat) && !isNaN(incLon)) {
                const href = incFilename
                    ? `../incidents/${incFilename}`
                    : incId ? `../incidents/index.html` : '';

                const popupHTML = href
                    ? `<b>${incidentTitle}</b><br><a href="${href}" style="color:#0284c7; font-weight:bold;">View Incident →</a>`
                    : `<b>${incidentTitle}</b>`;

                const el = document.createElement('div');
                el.className = 'marker-pin incident-pin';

                incidentMarker = new maplibregl.Marker({ element: el })
                    .setLngLat([incLon, incLat])
                    .setPopup(new maplibregl.Popup({ offset: 15 }).setHTML(popupHTML))
                    .addTo(window.map);
            }

            // Open appropriate popup
            if (context === 'coords' && incidentMarker) {
                incidentMarker.togglePopup();
            } else if (profileMarker) {
                profileMarker.togglePopup();
            } else if (incidentMarker) {
                incidentMarker.togglePopup();
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(() => {
                const map = window.map;
                if (!map) return;

                // Add Recent Profiles (Strictly Recent Only)
                const profiles = [{ "profil_id": 24684, "datum": "2026-01-25 10:10:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Lechleiter Alm", "seehoehe": 1773, "latitude": 47.27034, "longitude": 10.20819, "hangneigung": 30, "exposition_id": 2, "loggedon": "2026-01-25 18:05:48", "revision": 1, "location": "Lechleiter Alm", "elevation": 1773, "slope": 30, "neigung": 30, "aspect": 2, "exposition": 2, "comments": "ECTP 0@88.0cm: plötzlicher Bruch (P) (ganzer Block)", "comments_en": "ECTP 0@88.0cm: sudden break (P) (entire block)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 0, "height": 88, "result": { "text": "propagation (P)" } }] }, { "profil_id": 24620, "datum": "2026-01-21 13:20:00", "country_id": 1, "region_id": 1, "subregion_id": 164, "ort": "Kälberlangzugjoch", "seehoehe": 2450, "latitude": 47.20056, "longitude": 10.34711, "hangneigung": 25, "exposition_id": 1, "loggedon": "2026-01-22 08:52:29", "revision": 1, "location": "Kälberlangzugjoch", "elevation": 2450, "slope": 25, "neigung": 25, "aspect": 1, "exposition": 1, "comments": "ECTN 20@69.0cm: Teilbruch (N)\nECTN 5@80.0cm: Teilbruch (N)\nECTN 21@69.0cm: Teilbruch (N)", "comments_en": "ECTN 20@69.0cm: partial fraction (N)\nECTN 5@80.0cm: partial fraction (N)\nECTN 21@69.0cm: Partial fraction (N)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 20, "height": 69, "result": { "text": "no propagation (N)" } }, { "type": { "text": "ECT" }, "step": 5, "height": 80, "result": { "text": "no propagation (N)" } }, { "type": { "text": "ECT" }, "step": 21, "height": 69, "result": { "text": "no propagation (N)" } }] }, { "profil_id": 24618, "datum": "2026-01-21 12:30:00", "country_id": 1, "region_id": 1, "subregion_id": 164, "ort": "Kälberlangzugjoch", "seehoehe": 2440, "latitude": 47.20006, "longitude": 10.34862, "hangneigung": 38, "exposition_id": 5, "loggedon": "2026-01-22 07:43:56", "revision": 4, "location": "Kälberlangzugjoch", "elevation": 2440, "slope": 38, "neigung": 38, "aspect": 5, "exposition": 5, "comments": "ECTN 5@34.0cm: Teilbruch (N)", "comments_en": "ECTN 5@34.0cm: Partial fraction (N)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 5, "height": 34, "result": { "text": "no propagation (N)" } }] }, { "profil_id": 24619, "datum": "2026-01-21 11:30:00", "country_id": 1, "region_id": 1, "subregion_id": 164, "ort": "Kälberlangzug", "seehoehe": 2300, "latitude": 47.19586, "longitude": 10.34957, "hangneigung": 29, "exposition_id": 3, "loggedon": "2026-01-22 08:03:56", "revision": 2, "location": "Kälberlangzug", "elevation": 2300, "slope": 29, "neigung": 29, "aspect": 3, "exposition": 3, "comments": "#SNP-FC\nECTN 14@69.0cm: Teilbruch (N)\nECTN 12@83.0cm: Teilbruch (N)\nECTP 15@69.0cm: plötzlicher Bruch (P) (ganzer Block)\norographisch rechts von relativ frischer Lawine", "comments_en": "#SNP-FC\nECTN 14@69.0cm: Partial fracture (N)\nECTN 12@83.0cm: Partial fracture (N)\nECTP 15@69.0cm: Sudden fracture (P) (entire block)\norographically to the right of a relatively recent avalanche", "stability_tests": [{ "type": { "text": "ECT" }, "step": 14, "height": 69, "result": { "text": "no propagation (N)" } }, { "type": { "text": "ECT" }, "step": 12, "height": 83, "result": { "text": "no propagation (N)" } }, { "type": { "text": "ECT" }, "step": 15, "height": 69, "result": { "text": "propagation (P)" } }] }, { "profil_id": 24558, "datum": "2026-01-18 12:00:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Hornbachjoch", "seehoehe": 1934, "latitude": 47.35649, "longitude": 10.3885, "hangneigung": 31, "exposition_id": 2, "loggedon": "2026-01-18 19:52:34", "revision": 1, "location": "Hornbachjoch", "elevation": 1934, "slope": 31, "neigung": 31, "aspect": 2, "exposition": 2, "comments": "ECT 31 : kein Bruch", "comments_en": "ECT 31: no fracture", "stability_tests": [{ "type": { "text": "ECT" }, "step": 31, "height": null, "result": { "text": "" } }] }, { "profil_id": 24536, "datum": "2026-01-17 11:32:00", "country_id": 1, "region_id": 1, "subregion_id": 164, "ort": "Älpele", "seehoehe": 2192, "latitude": 47.23389, "longitude": 10.20262, "hangneigung": 32, "exposition_id": 2, "loggedon": "2026-01-17 19:12:01", "revision": 2, "location": "Älpele", "elevation": 2192, "slope": 32, "neigung": 32, "aspect": 2, "exposition": 2, "comments": "ECT 31: kein Bruch", "comments_en": "ECT 31: no fracture", "stability_tests": [{ "type": { "text": "ECT" }, "step": 31, "height": null, "result": { "text": "" } }] }, { "profil_id": 24530, "datum": "2026-01-17 09:15:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Jöchelspitze", "seehoehe": 1697, "latitude": 47.27383, "longitude": 10.36612, "hangneigung": 3, "exposition_id": 5, "loggedon": "2026-01-17 16:34:36", "revision": 1, "location": "Jöchelspitze", "elevation": 1697, "slope": 3, "neigung": 3, "aspect": 5, "exposition": 5, "comments": "ECTN 2@53.0cm: Teilbruch (N)\nECTP 17@27.0cm: plötzlicher Bruch (P) (ganzer Block)", "comments_en": "ECTN 2@53.0cm: Partial fracture (N)\nECTP 17@27.0cm: Sudden fracture (P) (entire block)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 2, "height": 53, "result": { "text": "no propagation (N)" } }, { "type": { "text": "ECT" }, "step": 17, "height": 27, "result": { "text": "propagation (P)" } }] }, { "profil_id": 24494, "datum": "2026-01-15 10:15:00", "country_id": 1, "region_id": 2, "subregion_id": 82, "ort": "Liechelkopf", "seehoehe": 2065, "latitude": 47.29743, "longitude": 10.18351, "hangneigung": 30, "exposition_id": 2, "loggedon": "2026-01-16 12:18:04", "revision": 1, "location": "Liechelkopf", "elevation": 2065, "slope": 30, "neigung": 30, "aspect": 2, "exposition": 2, "comments": "Nur bis 90 cm gegraben.\n\nECTN 11@173.0cm: Teilbruch (N)", "comments_en": "Excavated only to a depth of 90 cm.\n\nECTN 11@173.0 cm: Partial fracture (N)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 11, "height": 173, "result": { "text": "no propagation (N)" } }] }, { "profil_id": 24509, "datum": "2026-01-13 13:30:00", "country_id": 4, "region_id": 17, "subregion_id": 297, "ort": "Fellhorn", "seehoehe": 1600, "latitude": 47.35249, "longitude": 10.22863, "hangneigung": 27, "exposition_id": 3, "loggedon": "2026-01-16 15:42:43", "revision": 2, "location": "Fellhorn", "elevation": 1600, "slope": 27, "neigung": 27, "aspect": 3, "exposition": 3 }, { "profil_id": 24428, "datum": "2026-01-13 13:10:00", "country_id": 1, "region_id": 1, "subregion_id": 164, "ort": "Fürmesgumpalpe", "seehoehe": 2300, "latitude": 47.19177, "longitude": 10.20271, "hangneigung": 40, "exposition_id": 3, "loggedon": "2026-01-13 14:49:33", "revision": 1, "location": "Fürmesgumpalpe", "elevation": 2300, "slope": 40, "neigung": 40, "aspect": 3, "exposition": 3, "comments": "ECTN 12@21.0cm: Teilbruch (N) (1)\nECTN 12@21.0cm: Teilbruch (N) (2)", "comments_en": "ECTN 12@21.0cm: Partial fraction (N) (1)\nECTN 12@21.0cm: Partial fraction (N) (2)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 12, "height": 21, "result": { "text": "no propagation (N)" } }, { "type": { "text": "ECT" }, "step": 12, "height": 21, "result": { "text": "no propagation (N)" } }] }, { "profil_id": 24410, "datum": "2026-01-12 10:45:00", "country_id": 1, "region_id": 2, "subregion_id": 82, "ort": "Riezlern", "seehoehe": 1800, "latitude": 47.35351, "longitude": 10.11609, "hangneigung": 35, "exposition_id": 1, "loggedon": "2026-01-12 13:49:17", "revision": 2, "neigung": 35, "exposition": 1 }, { "profil_id": 24406, "datum": "2026-01-11 16:15:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Nesselwängle / Krinnenalm", "seehoehe": 1500, "latitude": 47.47931, "longitude": 10.59279, "hangneigung": 36, "exposition_id": 3, "loggedon": "2026-01-11 21:07:55", "revision": 2, "location": "Nesselwängle / Krinnenalm", "elevation": 1500, "slope": 36, "neigung": 36, "aspect": 3, "exposition": 3, "comments": "CT 13@63.0cm: plötzlicher Bruch glatt (SP)\nCT 22@38.0cm: plötzlicher Bruch mit Kollaps (SC)", "comments_en": "CT 13@63.0cm: Sudden smooth fracture (SP)\nCT 22@38.0cm: Sudden fracture with collapse (SC)" }, { "profil_id": 24408, "datum": "2026-01-11 16:00:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Nesslwängle-Krinnenalplift", "seehoehe": 1604, "latitude": 47.4798, "longitude": 10.59044, "hangneigung": 35, "exposition_id": 8, "loggedon": "2026-01-12 08:05:53", "revision": 1, "location": "Nesslwängle-Krinnenalplift", "elevation": 1604, "slope": 35, "neigung": 35, "aspect": 8, "exposition": 8, "comments": "ECTN 16@53.0cm: Teilbruch (N)", "comments_en": "ECTN 16@53.0cm: Partial fraction (N)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 16, "height": 53, "result": { "text": "no propagation (N)" } }] }, { "profil_id": 24404, "datum": "2026-01-11 14:50:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Jöchelspitze Standprofil", "seehoehe": 1697, "latitude": 47.27295, "longitude": 10.36491, "hangneigung": 3, "exposition_id": 5, "loggedon": "2026-01-11 20:20:51", "revision": 1, "location": "Jöchelspitze Standprofil", "elevation": 1697, "slope": 3, "neigung": 3, "aspect": 5, "exposition": 5, "comments": "ECTN 16@49.0cm: Teilbruch (N)", "comments_en": "ECTN 16@49.0cm: Partial fraction (N)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 16, "height": 49, "result": { "text": "no propagation (N)" } }] }, { "profil_id": 24519, "datum": "2026-01-11 14:00:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Oberhalb Almboden ", "seehoehe": 1620, "latitude": 47.47931, "longitude": 10.58018, "hangneigung": 35, "exposition_id": 2, "loggedon": "2026-01-17 11:49:52", "revision": 2, "location": "Oberhalb Almboden ", "elevation": 1620, "slope": 35, "neigung": 35, "aspect": 2, "exposition": 2, "comments": "Neuschnee 02-03.01 mit Windspitzen bis 100 kmh. Neuerlicher Neuschnee und Regen mit Wind bis 90kmh am 09.01. aus West. 10.01. Hochnebel ab ca. 1300m dadurch Oberflächenreif gebildet. Schicht ca. 2cm.\nECTP 13@56.0cm: plötzlicher Bruch (P) (ganzer Block)", "comments_en": "Fresh snowfall on January 2nd-3rd with wind gusts up to 100 km/h. Further fresh snowfall and rain with winds up to 90 km/h from the west on January 9th. On January 10th, high fog formed above approximately 1300 m, resulting in surface hoar. The layer was approximately 2 cm thick.\n\nECTP 13@56.0 cm: sudden fracture (P) (entire block)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 13, "height": 56, "result": { "text": "propagation (P)" } }] }, { "profil_id": 24401, "datum": "2026-01-11 10:30:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Lechleitner Alpe", "seehoehe": 1780, "latitude": 47.27033, "longitude": 10.20808, "hangneigung": 34, "exposition_id": 1, "loggedon": "2026-01-11 17:59:47", "revision": 2, "location": "Lechleitner Alpe", "elevation": 1780, "slope": 34, "neigung": 34, "aspect": 1, "exposition": 1, "comments": "ECTN 6@108.0cm: Teilbruch (N)\nECTP 12@65.0cm: plötzlicher Bruch (P) (ganzer Block)", "comments_en": "ECTN 6@108.0cm: Partial fracture (N)\nECTP 12@65.0cm: Sudden fracture (P) (entire block)", "stability_tests": [{ "type": { "text": "ECT" }, "step": 6, "height": 108, "result": { "text": "no propagation (N)" } }, { "type": { "text": "ECT" }, "step": 12, "height": 65, "result": { "text": "propagation (P)" } }] }, { "profil_id": 24403, "datum": "2026-01-11 10:15:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Lechleitner  Alpe", "seehoehe": 1820, "latitude": 47.27012, "longitude": 10.2166, "hangneigung": 34, "exposition_id": 1, "loggedon": "2026-01-11 19:49:34", "revision": 1, "location": "Lechleitner  Alpe", "elevation": 1820, "slope": 34, "neigung": 34, "aspect": 1, "exposition": 1, "comments": "ECTN 7@108.0cm: Teilbruch (N)\nECTP 11@68.0cm: plötzlicher Bruch (P) (ganzer Block)\nRB 4@68.0cm: ganzer Block", "comments_en": "ECTN 7@108.0cm: Partial fracture (N)\nECTP 11@68.0cm: Sudden fracture (P) (entire block)\nRB 4@68.0cm: Entire block", "stability_tests": [{ "type": { "text": "ECT" }, "step": 7, "height": 108, "result": { "text": "no propagation (N)" } }, { "type": { "text": "ECT" }, "step": 11, "height": 68, "result": { "text": "propagation (P)" } }] }, { "profil_id": 24356, "datum": "2026-01-08 09:15:00", "country_id": 1, "region_id": 1, "subregion_id": 158, "ort": "Jöchelspitze ", "seehoehe": 1697, "latitude": 47.274473027547, "longitude": 10.365681542627, "hangneigung": 3, "exposition_id": 5, "loggedon": "2026-01-08 17:01:48", "revision": 1, "location": "Jöchelspitze ", "elevation": 1697, "slope": 3, "neigung": 3, "aspect": 5, "exposition": 5, "comments": "LO.LA Profile\n\n\nECT PP 14 @ 16 (from ground)", "comments_en": "LO.LA profiles\n\n\nECT PP 14 @ 16 (from ground)" }, { "profil_id": 24325, "datum": "2026-01-06 13:30:00", "country_id": 1, "region_id": 1, "subregion_id": 164, "ort": "Höllkar (Grüngehrengrat)", "seehoehe": 2300, "latitude": 47.24082, "longitude": 10.20364, "hangneigung": 35, "exposition_id": 3, "loggedon": "2026-01-07 10:20:00", "revision": 1, "location": "Höllkar (Grüngehrengrat)", "elevation": 2300, "slope": 35, "neigung": 35, "aspect": 3, "exposition": 3, "comments": "Profilstandort kammnahe  ca. 30hm unterhalb vom Grat\nRichtung Nord selbe Krusten & drunter großflächige Becher- & Kantige Kristalle", "comments_en": "Profile location near the ridge, approximately 30 meters below the crest.\nTo the north, same crusts; below them, large cup-shaped and angular crystals." }];
                profiles.forEach(p => {
                    if (p.latitude && p.longitude) {
                        // Differentiate user uploads with Orange (#f97316), matching the UI button
                        const isUser = p.isUserUpload;
                        const color = isUser ? "#f97316" : "#0284c7";

                        const el = document.createElement('div');
                        el.className = 'marker-pin recent-pin';
                        el.style.backgroundColor = color;
                        if (isUser) {
                            el.style.width = '20px';
                            el.style.height = '20px';
                        }

                        const backParam = window.location.search; // Pass current context if any
                        const popupHTML = `<b>${p.ort}</b><br><span style="font-size:0.8rem">${p.datum}</span><br><a href="${p.profil_id || p.id}.html${backParam}" target="_top" style="color:${color}; font-weight:bold;">View Profile →</a>`;

                        new maplibregl.Marker({ element: el })
                            .setLngLat([p.longitude, p.latitude])
                            .setPopup(new maplibregl.Popup({ offset: 10 }).setHTML(popupHTML))
                            .addTo(map);
                    }
                });
            }, 100);
        });
    </script>
</body>

</html>